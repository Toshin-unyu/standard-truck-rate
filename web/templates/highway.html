<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高速道路料金検索 - STR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">高速道路料金検索</h1>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <form id="tollForm" class="space-y-4">
                <!-- 出発IC -->
                <div class="relative">
                    <label class="block text-sm font-medium text-gray-700 mb-1">出発IC</label>
                    <input type="text" id="originIC" name="origin"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="IC名を入力..."
                           autocomplete="off">
                    <div id="originSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg hidden max-h-60 overflow-y-auto"></div>
                </div>

                <!-- 到着IC -->
                <div class="relative">
                    <label class="block text-sm font-medium text-gray-700 mb-1">到着IC</label>
                    <input type="text" id="destIC" name="dest"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="IC名を入力..."
                           autocomplete="off">
                    <div id="destSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg hidden max-h-60 overflow-y-auto"></div>
                </div>

                <!-- 車種 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">車種</label>
                    <select id="carType" name="car_type"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="0">軽自動車等（軽貨物/赤帽）</option>
                        <option value="2">中型車（4t）</option>
                        <option value="3" selected>大型車（10t）</option>
                        <option value="4">特大車（トレーラー）</option>
                    </select>
                </div>

                <!-- 検索ボタン -->
                <button type="submit" id="searchBtn"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-400">
                    料金を検索
                </button>
            </form>
        </div>

        <!-- 結果表示 -->
        <div id="result" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">検索結果</h2>

                <div id="resultContent">
                    <!-- 結果がここに表示される -->
                </div>
            </div>
        </div>

        <!-- エラー表示 -->
        <div id="error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md">
            <span id="errorMessage"></span>
        </div>
    </div>

    <script>
        // オートコンプリート機能
        function setupAutocomplete(inputId, suggestionsId) {
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);
            let debounceTimer;

            input.addEventListener('input', function() {
                clearTimeout(debounceTimer);
                const query = this.value.trim();

                if (query.length < 1) {
                    suggestions.classList.add('hidden');
                    return;
                }

                debounceTimer = setTimeout(() => {
                    fetch(`/api/highway/ic/search?q=${encodeURIComponent(query)}`)
                        .then(res => res.json())
                        .then(data => {
                            suggestions.innerHTML = '';
                            if (data.ics && data.ics.length > 0) {
                                data.ics.forEach(ic => {
                                    const div = document.createElement('div');
                                    div.className = 'px-3 py-2 cursor-pointer hover:bg-gray-100 border-b last:border-b-0';
                                    div.innerHTML = `<span class="font-medium">${ic.name}</span> <span class="text-sm text-gray-500">${ic.road_name}</span>`;
                                    div.addEventListener('click', () => {
                                        input.value = ic.name;
                                        suggestions.classList.add('hidden');
                                    });
                                    suggestions.appendChild(div);
                                });
                                suggestions.classList.remove('hidden');
                            } else {
                                suggestions.classList.add('hidden');
                            }
                        });
                }, 200);
            });

            // 入力欄外クリックで候補を閉じる
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.classList.add('hidden');
                }
            });
        }

        // 料金検索
        document.getElementById('tollForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const origin = document.getElementById('originIC').value.trim();
            const dest = document.getElementById('destIC').value.trim();
            const carType = document.getElementById('carType').value;

            if (!origin || !dest) {
                showError('出発ICと到着ICを入力してください');
                return;
            }

            const btn = document.getElementById('searchBtn');
            btn.disabled = true;
            btn.textContent = '検索中...';

            fetch(`/api/highway/toll?origin=${encodeURIComponent(origin)}&dest=${encodeURIComponent(dest)}&car_type=${carType}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showResult(data);
                    } else {
                        showError(data.error || '料金を取得できませんでした');
                    }
                })
                .catch(err => {
                    showError('通信エラーが発生しました');
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = '料金を検索';
                });
        });

        function showResult(data) {
            document.getElementById('error').classList.add('hidden');
            const result = document.getElementById('result');
            const content = document.getElementById('resultContent');

            const hours = Math.floor(data.duration_min / 60);
            const mins = data.duration_min % 60;
            const durationStr = hours > 0 ? `${hours}時間${mins}分` : `${mins}分`;

            content.innerHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between border-b pb-2">
                        <span class="text-gray-600">区間</span>
                        <span class="font-medium">${data.origin_ic} → ${data.dest_ic}</span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="text-gray-600">車種</span>
                        <span class="font-medium">${data.car_type_name}</span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="text-gray-600">距離</span>
                        <span class="font-medium">${data.distance_km.toFixed(1)} km</span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="text-gray-600">所要時間</span>
                        <span class="font-medium">${durationStr}</span>
                    </div>
                    <div class="mt-4 pt-2">
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div class="bg-gray-50 p-3 rounded">
                                <div class="text-sm text-gray-500">通常料金</div>
                                <div class="text-xl font-bold text-gray-800">&yen;${data.normal_toll.toLocaleString()}</div>
                            </div>
                            <div class="bg-blue-50 p-3 rounded">
                                <div class="text-sm text-blue-600">ETC料金</div>
                                <div class="text-xl font-bold text-blue-700">&yen;${data.etc_toll.toLocaleString()}</div>
                            </div>
                            <div class="bg-green-50 p-3 rounded">
                                <div class="text-sm text-green-600">ETC2.0</div>
                                <div class="text-xl font-bold text-green-700">&yen;${data.etc2_toll.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                    ${data.from_cache ? '<div class="text-xs text-gray-400 mt-2 text-right">キャッシュから取得</div>' : ''}
                </div>
            `;

            result.classList.remove('hidden');
        }

        function showError(message) {
            document.getElementById('result').classList.add('hidden');
            const error = document.getElementById('error');
            document.getElementById('errorMessage').textContent = message;
            error.classList.remove('hidden');
        }

        // 初期化
        setupAutocomplete('originIC', 'originSuggestions');
        setupAutocomplete('destIC', 'destSuggestions');
    </script>
</body>
</html>
