# 要件定義書：Standard Truck Rate (STR)

トラック運賃簡易予測システム

---

## 1. 目的

社内における物流コストの概算把握を迅速化するため、全日本トラック協会の「標準的な運賃」および「赤帽運賃」をベースとした簡易見積もりツールを構築する。

---

## 2. システム概要

出発地・目的地の入力および車両条件の指定により、概算運賃を即座に算出・比較できるWebアプリケーション。

**距離制・時間制・赤帽の3つの運賃を自動計算し、一覧で比較可能。**

---

## 3. 技術スタック

運用コストの固定化（VPS利用）とメンテナンス負荷の低減を最優先とする。

| 項目 | 技術 |
|------|------|
| 開発手法 | バイブコーディング（Claude Code） |
| 言語 | Go 1.21以上 |
| Webフレームワーク | Echo または Gin |
| フロントエンド | Go HTML Templates + HTMX（Node.js/npm非依存） |
| データベース | SQLite 3（ファイルベース） |
| リバースプロキシ | nginx（BASIC認証） |
| デプロイ | Docker / Docker Compose |
| CSS | Tailwind CSS（CDNまたはスタンドアロンCLI） |
| 距離・時間取得 | Google Maps Routes API（自社契約） |
| 標準運賃（距離制） | 全日本トラック協会 Supabase API |
| 標準運賃（時間制） | 自社マスタ（PDFから手動登録） |
| 高速道路料金 | ドラぷら（NEXCO）スクレイピング |

---

## 4. 機能要件

### 4.1 運賃シミュレーション機能

#### 入力項目

| 項目 | 説明 |
|------|------|
| 出発地・目的地 | 都道府県・市区町村レベル |
| 輸送距離 (km) | Google Maps APIによる自動取得、または手入力 |
| 所要時間 | Google Maps APIによる自動取得（時間制計算用） |
| 荷役時間 | 積み下ろし想定時間（デフォルト1時間、変更可） |
| 車両種別 | 軽貨物/赤帽、2t、4t、大型、トレーラー |
| 届出運輸局 | 北海道〜沖縄（10地域） |
| 割増条件 | 深夜・休日 |

#### 出力項目

| 項目 | 説明 |
|------|------|
| 距離制運賃 | 全日本トラック協会基準（距離ベース） |
| 時間制運賃 | 全日本トラック協会基準（時間ベース） |
| 赤帽運賃 | 比較用（軽貨物のみ） |
| 計算根拠 | 適用した料金表・割増率・計算過程の明示 |

### 4.2 標準運賃・距離制（トラ協Supabase連携）

#### データソース

全日本トラック協会の運賃計算サイト（https://fare.jta.support/）が使用するSupabase APIから直接取得する。

#### 接続情報

| 項目 | 値 |
|------|-----|
| Supabase URL | `https://pwnkpkeelpsxlvyxsaml.supabase.co` |
| テーブル | `fare_rates`（運賃）、`charge_data`（付帯料金） |
| 認証 | anon key（公開） |

#### 取得データ

| テーブル | 内容 |
|----------|------|
| fare_rates | 地域別・車格別・距離別の運賃（約1,000件） |
| charge_data | 待機時間料・作業料マスタ（約24件） |

#### 運賃計算距離の丸めロジック

```
距離 ≤ 200km  → 10km単位で切り上げ
距離 ≤ 500km  → 20km単位で切り上げ
距離 > 500km  → 50km単位で切り上げ
※沖縄のみ特別ルールあり（5km, 10km区分）
```

#### コードマッピング

**運輸局コード (region_code)**

| 地域 | コード |
|------|--------|
| 北海道 | 1 |
| 東北 | 2 |
| 関東 | 3 |
| 北陸信越 | 4 |
| 中部 | 5 |
| 近畿 | 6 |
| 中国 | 7 |
| 四国 | 8 |
| 九州 | 9 |
| 沖縄 | 10 |

**車格コード (vehicle_code)**

| 車格 | コード |
|------|--------|
| 軽貨物/赤帽 | 0 |
| 小型車(2t) | 1 |
| 中型車(4t) | 2 |
| 大型車(10t) | 3 |
| トレーラー(20t) | 4 |

### 4.3 標準運賃・時間制（自社マスタ管理）

トラ協Supabaseには時間制運賃が含まれないため、PDF資料をもとに自社マスタで管理する。

#### データソース

- 全日本トラック協会「標準的な運賃」時間制運賃表
- https://jta.or.jp/wp-content/themes/jta_theme/pdf/hyoujun_unchin202403/jikan.pdf

#### 料金体系

**制度区分**

| 制度 | 基礎時間 | 基礎走行キロ |
|------|----------|-------------|
| 8時間制 | 8時間 | 小型車100km / その他130km |
| 4時間制 | 4時間 | 小型車50km / その他60km |

**基礎額（例：関東運輸局）**

| 制度 | 小型車(2t) | 中型車(4t) | 大型車(10t) | トレーラー(20t) |
|------|-----------|-----------|------------|---------------|
| 8時間制 | 39,380 | 46,640 | 60,090 | 76,840 |
| 4時間制 | 23,630 | 27,980 | 36,050 | 46,100 |

**加算額（例：関東運輸局）**

| 項目 | 小型車(2t) | 中型車(4t) | 大型車(10t) | トレーラー(20t) |
|------|-----------|-----------|------------|---------------|
| 距離超過（10kmごと） | 350 | 410 | 630 | 930 |
| 時間超過（1時間ごと） | 3,710 | 3,890 | 4,180 | 4,920 |

#### 計算ロジック

```
1. 総作業時間 = 走行時間（API取得） + 荷役時間（入力）
2. 適用制度 = 総作業時間 ≤ 4時間 → 4時間制、それ以外 → 8時間制
3. 距離超過 = MAX(0, 走行距離 - 基礎走行キロ)
4. 時間超過 = MAX(0, 総作業時間 - 基礎時間)
5. 時間制運賃 = 基礎額 + 距離加算 + 時間加算
```

#### 更新方式

運賃改定時（年1回程度）に手動でマスタを更新する。

### 4.4 赤帽運賃（自社マスタ管理）

赤帽は公式計算サイトがないため、料金表をもとに自社マスタで管理する。

#### 料金体系（全国統一）

**距離制運賃**

| 距離区分 | 料金（税込） |
|----------|-------------|
| 20km迄 | 5,500円（基本料金） |
| 21〜50km | +242円/km |
| 51〜100km | +187円/km |
| 101〜150km | +154円/km |
| 151km以上 | +132円/km |

**時間制運賃**

| 項目 | 料金（税込） |
|------|-------------|
| 基本（2時間・20km迄） | 6,050円 |
| 超過30分ごと | +1,375円 |

**割増料金**

| 種別 | 割増率 |
|------|--------|
| 休日（日祝） | +20% |
| 深夜・早朝（22:00〜5:00） | +30% |

**地区割増**

| 地区 | 加算額（税込） |
|------|---------------|
| 東京23区 | +440円 |
| 大阪市内 | +440円 |

**付帯料金**

| 項目 | 料金（税込） |
|------|-------------|
| 作業料金（30分超過） | 550円/15分 |
| 待機時間（30分超過） | 1,100円/30分 |

#### 更新方式

運賃改定時に手動でマスタを更新する。

### 4.5 運用管理

| 項目 | 仕様 |
|------|------|
| 認証 | nginx による BASIC認証 |
| ログ | 標準出力によるコンテナログの保持 |

### 4.6 Google Maps API連携

| 項目 | 内容 |
|------|------|
| 使用API | Routes API（Essentials tier） |
| 契約 | 自社契約 |
| 用途 | 出発地・目的地間の距離(km)・所要時間(分)取得 |
| 月間無料枠 | 10,000リクエスト |
| フォールバック | API上限到達時は手入力のみ許可 |

### 4.7 API使用量管理

#### 表示機能

- 画面上部に常時表示：`今月のAPI使用量: 847 / 9,000`
- 使用率に応じた色分け表示
  - 0-79%: 通常（青/緑）
  - 80-94%: 警告（黄）
  - 95-100%: 危険（赤）

#### 制限機能

| 項目 | 仕様 |
|------|------|
| 上限値 | 9,000件/月（無料枠10,000の90%） |
| 上限到達時動作 | 距離の自動取得を停止、手入力のみ許可 |
| リセット | 毎月1日に自動リセット |

### 4.8 距離・時間キャッシュ

| 項目 | 仕様 |
|------|------|
| キャッシュ対象 | 出発地・目的地の組み合わせごとの距離(km)・所要時間(分) |
| キャッシュヒット時 | APIを呼ばずDBから取得 |
| 有効期限 | 無期限（道路距離・所要時間は基本的に不変） |
| 共有範囲 | 全端末で共有（サーバーサイドキャッシュ） |
| 永続化 | Docker Volume でホストにマウント |
| 効果 | 同一区間は初回のみAPI呼び出し、2回目以降は即時応答 |

### 4.9 高速道路料金取得（ドラぷら連携）

運賃計算に加えて、高速道路料金の概算取得機能を提供する。

#### データソース

ドラぷら（NEXCO東日本）の高速料金検索サービスを使用する。

| 項目 | 内容 |
|------|------|
| サービス | ドラぷら（https://www.driveplaza.com/） |
| 運営 | NEXCO東日本 |
| 取得方法 | Webスクレイピング |
| 利用規約 | 個人利用の範囲で使用 |

#### ICマスタ取得

ドラぷらのIC検索APIから全ICリストを取得し、ローカルマスタとして管理する。

| 項目 | 内容 |
|------|------|
| エンドポイント | `https://www.driveplaza.com/community/icsearch_api.php` |
| パラメータ | `val_word=`（空文字で全件取得） |
| レスポンス形式 | XML |
| 総件数 | 約2,200件 |

#### IC検索API レスポンス形式

```xml
<NexcoIC>
  <IcItem>
    <Code>1010001</Code>
    <Name>東京</Name>
    <Yomi>とうきょう</Yomi>
    <Type>1</Type>
    <RoadNo>1010</RoadNo>
    <RoadName>【E1】東名高速道路</RoadName>
  </IcItem>
</NexcoIC>
```

#### 車種区分

| carType | 車種名 | STR対応 |
|---------|--------|---------|
| 0 | 軽自動車等 | 軽貨物/赤帽 |
| 1 | 普通車 | - |
| 2 | 中型車 | 4t車 |
| 3 | 大型車 | 10t車 |
| 4 | 特大車 | トレーラー |

#### 料金取得方法

URLパラメータ直接構築でアクセスする。

```
https://www.driveplaza.com/dp/SearchQuick?
  startPlaceKana={出発IC名(URLエンコード)}
  &arrivePlaceKana={到着IC名(URLエンコード)}
  &carType={0-4}
```

#### 取得可能データ

| 項目 | 説明 |
|------|------|
| 通常料金 | 現金払い時の料金 |
| ETC料金 | ETC利用時の料金 |
| ETC2.0料金 | ETC2.0利用時の料金 |
| 所要時間 | 高速道路区間の所要時間 |
| 距離 | 高速道路区間の距離(km) |

#### UI仕様

| 項目 | 仕様 |
|------|------|
| IC選択方式 | ユーザー手動入力 + オートコンプリート |
| オートコンプリート | ローカルICマスタから部分一致検索 |
| 表示形式 | IC名 + 路線名（例：「東京 【E1】東名高速道路」） |

#### 注意事項

1. **リクエスト間隔**: 1-2秒の間隔を設ける
2. **IC名の正確性**: マスタと完全一致が必要
3. **将来リスク**: bot対策（reCAPTCHA等）導入の可能性

---

## 5. 非機能要件

| 要件 | 内容 |
|------|------|
| ポータビリティ | Dockerコンテナで動作し、環境依存を排除 |
| 軽量性 | VPSの最小スペック（メモリ1GB）で高速動作 |
| 保守性 | Node.jsのバージョン管理を排除、Go標準ライブラリとHTMXでフロントエンド完結 |
| 可用性 | 単一障害点なし（SQLiteファイルのバックアップで復旧可能） |
| セキュリティ | BASIC認証による社内アクセス制限 |

---

## 6. システム構成

### 6.1 アーキテクチャ

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  ブラウザ   │────▶│   nginx     │────▶│  STR (Go)   │
│            │     │ BASIC認証   │     │             │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
         ┌─────────────────┬───────────────────┼───────────────────┬─────────────────┐
         │                 │                   │                   │                 │
         ▼                 ▼                   ▼                   ▼                 ▼
┌─────────────┐   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐   ┌─────────────┐
│ Google Maps │   │  Supabase   │     │  ドラぷら   │     │   SQLite    │   │   SQLite    │
│ Routes API  │   │ (トラ協)     │     │  (NEXCO)    │     │  (str.db)   │   │ (cache.db)  │
│ (距離/時間) │   │ (距離制運賃) │     │ (高速料金)  │     │(時間制/赤帽/│   │(ルート/料金 │
└─────────────┘   └─────────────┘     └─────────────┘     │  ICマスタ)  │   │  キャッシュ)│
                                                          └─────────────┘   └─────────────┘
```

### 6.2 Docker Compose構成

```yaml
services:
  str:
    build: .
    expose:
      - "8080"
    volumes:
      - ./data:/app/data    # SQLite永続化
    environment:
      - GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - ./.htpasswd:/etc/nginx/.htpasswd
    depends_on:
      - str
```

### 6.3 ディレクトリ構成（データ）

```
./data/
  ├── str.db          # メインDB（時間制運賃、赤帽マスタ、API使用量）
  └── cache.db        # 距離・時間キャッシュ
```

---

## 7. データ構造

### 7.1 jta_time_base_fares（トラ協時間制・基礎額）

| カラム名 | 型 | 説明 |
|----------|------|------|
| id | INTEGER | 連番（PK） |
| region_code | INTEGER | 運輸局コード（1-10） |
| vehicle_code | INTEGER | 車格コード（1-4） |
| hours | INTEGER | 制度区分（4 or 8） |
| base_km | INTEGER | 基礎走行キロ |
| fare_yen | INTEGER | 基礎額（円） |

### 7.2 jta_time_surcharges（トラ協時間制・加算額）

| カラム名 | 型 | 説明 |
|----------|------|------|
| id | INTEGER | 連番（PK） |
| region_code | INTEGER | 運輸局コード（1-10） |
| vehicle_code | INTEGER | 車格コード（1-4） |
| surcharge_type | TEXT | 'distance'（10kmごと）/ 'time'（1時間ごと） |
| fare_yen | INTEGER | 加算額（円） |

### 7.3 akabou_distance_fares（赤帽距離制運賃）

| カラム名 | 型 | 説明 |
|----------|------|------|
| id | INTEGER | 連番（PK） |
| min_km | INTEGER | 距離下限（km） |
| max_km | INTEGER | 距離上限（km）、NULLは上限なし |
| base_fare | INTEGER | 基本料金（円、税込）※20km以下のみ |
| per_km_rate | INTEGER | km単価（円、税込） |

### 7.4 akabou_time_fares（赤帽時間制運賃）

| カラム名 | 型 | 説明 |
|----------|------|------|
| id | INTEGER | 連番（PK） |
| base_hours | INTEGER | 基本時間（時間） |
| base_km | INTEGER | 基本距離（km） |
| base_fare | INTEGER | 基本料金（円、税込） |
| overtime_rate | INTEGER | 超過料金（円/30分、税込） |

### 7.5 akabou_surcharges（赤帽割増料金）

| カラム名 | 型 | 説明 |
|----------|------|------|
| id | INTEGER | 連番（PK） |
| surcharge_type | TEXT | holiday/night |
| rate_percent | INTEGER | 割増率（%） |
| description | TEXT | 説明 |

### 7.6 akabou_area_surcharges（赤帽地区割増）

| カラム名 | 型 | 説明 |
|----------|------|------|
| id | INTEGER | 連番（PK） |
| area_name | TEXT | 地区名（東京23区、大阪市内） |
| surcharge_amount | INTEGER | 加算額（円、税込） |

### 7.7 akabou_additional_fees（赤帽付帯料金）

| カラム名 | 型 | 説明 |
|----------|------|------|
| id | INTEGER | 連番（PK） |
| fee_type | TEXT | work/waiting |
| free_minutes | INTEGER | 無料時間（分） |
| unit_minutes | INTEGER | 課金単位（分） |
| fee_amount | INTEGER | 料金（円、税込） |

### 7.8 api_usage（API使用量）

| カラム名 | 型 | 説明 |
|----------|------|------|
| year_month | TEXT | 年月 'YYYY-MM'（PK） |
| request_count | INTEGER | リクエスト数 |
| limit_count | INTEGER | 上限値（デフォルト9000） |
| last_updated | DATETIME | 最終更新日時 |

### 7.9 route_cache（距離・時間キャッシュ）

| カラム名 | 型 | 説明 |
|----------|------|------|
| origin | TEXT | 出発地（PK） |
| dest | TEXT | 目的地（PK） |
| distance_km | REAL | 距離（km、小数点以下1桁） |
| duration_min | INTEGER | 所要時間（分） |
| created_at | DATETIME | 作成日時 |

### 7.10 highway_ic_master（高速道路ICマスタ）

| カラム名 | 型 | 説明 |
|----------|------|------|
| code | TEXT | IC識別コード（PK、7桁） |
| name | TEXT | IC名称 |
| yomi | TEXT | 読み仮名（ひらがな） |
| type | INTEGER | 種別（1=IC, 2=SA/PA） |
| road_no | TEXT | 路線番号 |
| road_name | TEXT | 路線名（ナンバリング付き） |
| updated_at | DATETIME | 最終更新日時 |

### 7.11 highway_toll_cache（高速料金キャッシュ）

| カラム名 | 型 | 説明 |
|----------|------|------|
| origin_ic | TEXT | 出発IC名（PK） |
| dest_ic | TEXT | 到着IC名（PK） |
| car_type | INTEGER | 車種区分（0-4、PK） |
| normal_toll | INTEGER | 通常料金（円） |
| etc_toll | INTEGER | ETC料金（円） |
| etc2_toll | INTEGER | ETC2.0料金（円） |
| distance_km | REAL | 高速道路距離（km） |
| duration_min | INTEGER | 高速道路所要時間（分） |
| created_at | DATETIME | 作成日時 |

---

## 8. 画面構成

### 8.1 メイン画面（運賃シミュレーション）

```
┌─────────────────────────────────────────────────────────┐
│ STR - トラック運賃簡易予測        API: 847/9,000 [====] │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  出発地: [都道府県 ▼] [市区町村        ]               │
│  目的地: [都道府県 ▼] [市区町村        ]               │
│                                                         │
│  距離:   [504.6 ] km   所要時間: [6:00]  [自動取得]    │
│                                                         │
│  車両:   ○軽貨物/赤帽 ○2t ○4t ●大型 ○トレーラー     │
│                                                         │
│  届出運輸局: [関東 ▼]    荷役時間: [1:00]              │
│                                                         │
│  割増:   □深夜 □休日                                  │
│                                                         │
│                    [見積もり計算]                       │
│                                                         │
├─────────────────────────────────────────────────────────┤
│ 【計算結果】                                            │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 距離制運賃      ¥182,480                        │   │
│  │ 時間制運賃      ¥67,280  ← 推奨（8時間制）     │   │
│  │ 赤帽運賃        ¥68,720  （参考・軽貨物のみ）   │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ───────────────────────────────────────────────────   │
│  【内訳：距離制】                                       │
│   └ 基本運賃 ¥182,480（大型・550km・関東）            │
│                                                         │
│  【内訳：時間制】                                       │
│   ├ 基礎額     ¥60,090（8時間制・大型・関東）         │
│   ├ 距離超過   ¥6,300（+100km × 630円/10km）          │
│   └ 時間超過   ¥890（+0.2h → 1h切り上げ）             │
│                                                         │
│  【計算根拠】                                           │
│   ├ 経路距離: 504.6km → 運賃計算距離: 550km           │
│   ├ 走行時間: 6時間00分（API取得）                    │
│   ├ 荷役時間: 1時間00分（入力値）                     │
│   ├ 総作業時間: 7時間00分 → 8時間制適用              │
│   └ 基礎走行キロ: 130km → 超過: 374.6km              │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 9. 今後の検討事項

| 項目 | 内容 | 優先度 |
|------|------|--------|
| 見積もり履歴保存 | 過去の計算結果を参照可能にするか | 低 |
| 複数地点経由 | A→B→Cのような複数経由地対応 | 低 |
| Google Maps連携IC自動選択 | 経路上の入口/出口ICを自動判定 | 中 |

---

## 10. 開発方針

### 10.1 バイブコーディング（Claude Code）

本プロジェクトはClaude Codeを使用したバイブコーディングで開発を行う。

| 項目 | 内容 |
|------|------|
| 開発ツール | Claude Code (Anthropic CLI) |
| 開発スタイル | 自然言語による指示 → AI実装 → レビュー |
| 品質担保 | TDD（テスト駆動開発）を基本とする |
| プロジェクト設定 | CLAUDE.md（プロジェクトルートに配置） |

### 10.2 開発フロー

```
1. 要件・仕様を自然言語で指示
2. Claude Codeがコードを生成
3. 人間がレビュー・承認
4. テストで動作確認
5. コミット・プッシュ
```

### 10.3 TDD（テスト駆動開発）

| フェーズ | 内容 |
|----------|------|
| Red | 期待する入出力に基づきテストを作成、失敗を確認 |
| Green | テストをパスする最小限の実装 |
| Refactor | コードの整理・最適化（テストは変更しない） |

### 10.4 コード品質方針

- シンプルで読みやすいコードを優先
- 過度な抽象化・最適化を避ける
- AIが理解・修正しやすい構造を維持
- 各関数・モジュールは単一責任を持つ

---

## 11. 改訂履歴

| 日付 | 版 | 内容 |
|------|------|------|
| 2026-01-27 | 1.0 | 初版作成 |
| 2026-01-28 | 2.0 | トラ協Supabase連携方式に変更、赤帽料金体系詳細化、BASIC認証追加、アーキテクチャ図追加 |
| 2026-01-28 | 2.1 | 時間制運賃対応追加、距離制・時間制・赤帽の3運賃併記方式に変更、所要時間キャッシュ追加 |
| 2026-01-28 | 2.2 | 開発方針（バイブコーディング・TDD）を追加 |
| 2026-01-29 | 2.3 | 高速道路料金取得機能（ドラぷら連携）を追加、ICマスタ・料金キャッシュのデータ構造追加 |
| 2026-02-05 | 2.4 | 車格コード表に軽貨物/赤帽(コード0)を追加 |
